<HTML>
<HEAD>
<TITLE>PM Message Queues</TITLE>
</HEAD>
<BODY>
<H1>PM Message Queues</H1><!-- entering slot 275 -->
<P>
PM messages are generated either as the result of user interaction with
the system or by the use of various PM APIs. Both PM and non-PM applications
may generate PM messages.
<P>
Messages may flow:<!-- lm: 0x2 6 -->
<UL>
<P>
synchronously, that is, require processing by the recipient before the sender
can continue, or<!-- lm: 0x2 6 -->
<P>
asynchronously, that is, where no reposonse is required.<!-- lm: 0x2 1 -->
</UL>
<P>
They may flow between threads (inter-thread messages) or from a thread to
itself (intra-thread messages).
<P>
These characteristics require a message queuing mechanism to be implemented
so that message order may be preserved.
<P>
<B>Note: </B>
<P>
A message's meaning may often depend on the outcome of a preceding message.
For example, consider the action of the F4 key after the Alt key has been
pressed.<!-- lm: 0x2 1 -->
<P>

<P>
Each PM message thread has two<I> queues</I> or more strictly speaking a
message queue and a message list. There may be only one instance of these
two structures per thread.<!-- lm: 0x2 3 -->
<UL>
<P>
<LI><!-- lm: 0x2 6 -->The message queue is a circular array, the size of
which is specified or defaulted by the application when it creates the queue
using<B> WinCreateMsgQueue</B>.
<P>
This queue is used for the receipt of asynchronous messages generated by
use of the<B> WinPostMsg</B> API.<!-- lm: 0x2 3 -->
<P>
<LI><!-- lm: 0x2 6 -->The message list has no depth and is created implicitly
by<B> WinCreateMsgQueue</B>.
<P>
This is used for the receipt of synchronous messages sent using<B> WinSendMsg</B>.
<!-- lm: 0x2 1 -->
</UL>
<P>
<B>WinCreateMsgQueue</B> also creates a message event semaphore that is
posted whenever a message, synchronous or asynchronous, is posted; or a
message response is generated.  This is the semaphore on which<B> WinGetMsg
</B> waits for message notification. 
<P>
There is a system queue, which is also a circular array. Messages are enqueued
on the system queue by the<B> PMDD.SYS</B> device driver as the result of
external events deriving directly from:<!-- lm: 0x2 6 -->
<UL>
<P>
Mouse activity<!-- lm: 0x2 6 -->
<P>
Keyboard activity<!-- lm: 0x2 6 -->
<P>
Use of a light pen<!-- lm: 0x2 6 -->
<P>
Timer ticks.<!-- lm: 0x2 1 -->
</UL> 
<P>
PM maintains knowledge of who the current, mouse, keyboard, pen, and event
receivers are. When an external event causes a message to be queued on the
system queue, PM posts the message event semaphore of the current receiver
of that particular event. 
<P>
An application may define<I> Window Procedures</I> - entry points within
the message thread. These are associated with a PM Window and a message
queue. They receive control when a message is dispatched, that is dequeued
from the message queue or message list. More than one window procedure may
be serviced by the same message queue/list. Which one should be dispatched
is determined from the<B> HWND</B>, which is one of the parameters associated
with a message. 
<P>
When<B> WinGetMsg</B> receives a message event notification, it first checks
for the presence of received synchronous messages, if there are any dispatches
them directly. Next it looks for an application generated (posted) message
and finally for a system queue message.
<P>
The application thread explicitly dispatches asynchronous messages using
<B>WinDispatchMsg</B>. 
<P>
The System Queue entries are<B> SQMSG</B> structures.
<P>
The Application Queue entries are<B> QMSG</B> structures.
<P>
The Application Send Message List comprises a chain of<B> SMS</B> structures.
 
<P>
This scenario is illustrated in the following diagram:<!-- Unable to decode bitmap format --><IMG SRC="185_L4_PMMessageQueues_18.gif" WIDTH=717 HEIGHT=1011>
 

<P><HR>

<A HREF="184_L4_ThePMMessagingEnviro.html">[Back: The PM Messaging Environment]</A> <BR>
<A HREF="186_L4_AnApplicationThreads.html">[Next: An Application Thread's Messaging Structures]</A> 
</BODY>
</HTML>
